# Exercise 5B: Advanced Tagging Strategies
#
# GOAL: Implement multiple tagging strategies using docker/metadata-action
#
# Building on Exercise 5A, you'll now add intelligent tagging that automatically
# generates multiple tags based on the Git event (branch, PR, tag, SHA).
#
# LEARNING OBJECTIVES:
# - Use docker/metadata-action for automated tag generation
# - Understand different tag types (branch, sha, semver, raw)
# - Add OCI labels to images for better metadata
# - Implement tag priority for "latest" tag
#
# REQUIREMENTS:
# 1. Trigger on push to 'test-workflows' branch
# 2. Create job named 'build-and-push-web'
# 3. Run on ubuntu-latest runner
# 4. Set permissions: contents: read, packages: write
# 5. Steps required:
#    a) Checkout repository code
#    b) Set up Docker Buildx
#    c) Log in to GHCR
#    d) Extract metadata with docker/metadata-action@v5
#       - Set the image name to: ghcr.io/<lowercase-owner>/devops-training
#       - Configure these tag types:
#         * type=ref,event=branch (branch name like "test-workflows")
#         * type=sha,prefix=sha- (commit SHA like "sha-abc1234")
#         * type=raw,value=latest,priority=200 (static "latest" tag)
#    e) Build and push using tags and labels from metadata step
#       - Use outputs from metadata step: tags and labels
#       - Enable GitHub Actions cache (same as 5A)
#
# HINTS:
# - Use docker/metadata-action@v5 before build-push step
# - Set 'images' input with lowercase repository owner
# - The metadata action outputs: 'tags' and 'labels'
# - Reference outputs with: ${{ steps.<step-id>.outputs.tags }}
# - For lowercase, you can use the same technique as 5A
#
# NEW SYNTAX EXPLAINED:
#
# ### docker/metadata-action@v5
# - **What:** Automatically generates Docker tags and labels from Git metadata
# - **Inputs:**
#   - images: The base image name (ghcr.io/username/image-name)
#   - tags: List of tag generation rules (type=ref, type=sha, etc.)
# - **Outputs:**
#   - tags: Generated tags separated by newlines
#   - labels: OCI labels with Git metadata
# - **When to use:** Any time you need smart, automatic tagging
#
# ### Tag Type: type=ref,event=branch
# - **What:** Creates tag from branch name
# - **Example:** Branch "main" → tag "main"
# - **Use case:** Know which branch an image came from
#
# ### Tag Type: type=sha,prefix=sha-
# - **What:** Creates tag from Git commit SHA (first 7 chars)
# - **Example:** Commit abc1234567 → tag "sha-abc1234"
# - **Use case:** Trace image back to exact code commit
#
# ### Tag Type: type=raw,value=latest,priority=200
# - **What:** Static tag that doesn't change
# - **priority=200:** Higher number = appears later in tag list
# - **Use case:** Always have a "latest" tag for convenience
#
# ### Step Outputs: ${{ steps.<id>.outputs.<name> }}
# - **What:** Reference outputs from previous steps
# - **Format:** steps.<step-id>.outputs.<output-name>
# - **Example:** ${{ steps.meta.outputs.tags }}
# - **Use case:** Pass data between steps (like tags, versions, URLs)
#
# VERIFICATION:
# After pushing to test-workflows branch, you should see THREE tags:
# 1. ghcr.io/<username>/devops-training:test-workflows (branch)
# 2. ghcr.io/<username>/devops-training:sha-<commit> (SHA)
# 3. ghcr.io/<username>/devops-training:latest (static)
#
# YOUR SOLUTION BELOW:
# ====================

name: Solution 5B - Advanced Tagging

on:
  workflow_dispatch:

jobs:
  build-and-push-web:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Docker buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set lowercase owner name
        env:
          OWNER: "${{ github.repository_owner }}"
        run: |
          echo "OWNER_LC=$(echo $OWNER | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      - name: Extract metadata
        id: metadata
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ env.OWNER_LC }}/devops-training
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,priority=200
      - name: Build and push with tags/labels
        uses: docker/build-push-action@v6
        with:
          context: "./components/web"
          file: "./components/web/Dockerfile"
          push: true
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max