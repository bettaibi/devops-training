# Exercise 2: Matrix Strategies & Artifacts
#
# GOAL: Create a workflow that tests across multiple Node versions
#       and passes build artifacts to the deploy job
#
# Requirements:
# 1. Create a 'test' job that runs on Node 18, 20, and 22 using matrix strategy
#    - Checkout code
#    - Setup Node with the matrix version
#    - Install dependencies (npm ci)
#    - Run tests (npm test)
#
# 2. Create a 'build' job that:
#    - Runs AFTER all test matrix jobs pass
#    - Uses Node 22
#    - Builds the project (npm run build)
#    - Uploads the '.next' folder as an artifact named 'build-output'
#
# 3. Create a 'deploy' job that:
#    - Runs AFTER build job passes
#    - Downloads the 'build-output' artifact
#    - Echoes "Deploying build from artifact..."
#
# HINTS:
# - Use 'needs' to create job dependencies
# - Matrix syntax: strategy.matrix.node-version: [18, 20, 22]
# - Access matrix value: ${{ matrix.node-version }}
# - Upload action: actions/upload-artifact@v4
# - Download action: actions/download-artifact@v4
#
# Reference: Your completed exercise-01 for basic structure
#
# YOUR SOLUTION BELOW:
# ====================

name: Matrix & Artifacts (Exercise 2)
# NOTE: Using workflow_dispatch to prevent auto-running when pushing
# To test: Go to Actions tab → Select this workflow → "Run workflow"
on:
  workflow_dispatch:

jobs:
  # TODO: Create 'test' job with matrix strategy for Node 18, 20, 22
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./components/web
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm ci
      - name: Run tests
        run: npm test
      - name: Run tests
        run: npm test
  # TODO: Create 'build' job that uploads .next folder as artifact
  build:
    needs: [test]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./components/web
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Debug - List files after build
        run: |
          echo "Current working directory:"
          pwd
          echo "Files in current directory:"
          ls -la
          echo "Checking for .next folder:"
          ls -la .next || echo ".next folder not found"
          echo "From repo root, checking components/web/.next:"
          cd ${{ github.workspace }}
          ls -la components/web/.next 2>/dev/null || echo "Path not found from workspace root"
          echo "Verifying .next exists:"
          test -d components/web/.next && echo "✓ .next directory exists" || echo "✗ .next directory NOT found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ${{ github.workspace }}/components/web/.next/
          include-hidden-files: true  # Explicitly tell it to include .next
  # TODO: Create 'deploy' job that downloads and uses the artifact
  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./components/web
    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ./components/web/.next
      - name: Deploying
        run: echo "Deploying build from artifact..."
